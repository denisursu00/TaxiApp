<app-loading *ngIf="loading"></app-loading>
<p-panel [toggleable]="true">
    <p-header>
        {{'LABELS.REPORT_PARTICIPARI_LA_EVENIMENTE' | translate}}
    </p-header>
    <form [formGroup]="formGroup">
        <div class="ui-grid ui-grid-responsive ui-grid-pad ui-fluid">
            <div class="ui-grid-row">
                <div class="ui-grid-col-3">
					{{'LABELS.REPORT_PARTICIPARI_LA_EVENIMENTE_FILTER_DATA_INCEPUT' | translate}}*:
                </div>
                <div class="ui-grid-col-9">
					<p-calendar formControlName="dataInceput"
							showIcon="true" 
							[dateFormat]="dateFormat"
							monthNavigator="true" 
							yearNavigator="true"
							[yearRange]="yearRange"
							showButtonBar="true"
							appendTo="body" 
							[dataType]="'date'">
					</p-calendar>
				</div>
            </div>
            <div class="ui-grid-row">
				<div class="ui-grid-col-3"></div>
				<div class="ui-grid-col-9">
					<div *ngIf="dataInceputFormControl.invalid && (dataInceputFormControl.dirty || dataInceputFormControl.touched)" class="ui-message ui-widget ui-corner-all ui-message-error">
						<span class="ui-message-icon pi pi-times"></span>
						<span *ngIf="dataInceputFormControl.errors['required']" class="ui-message-text">{{'MESSAGES.VALIDATOR_MANDATORY_FIELD' | translate}}</span>
					</div>
				</div>
            </div>  

            <div class="ui-grid-row">
                <div class="ui-grid-col-3">
					{{'LABELS.REPORT_PARTICIPARI_LA_EVENIMENTE_FILTER_DATA_SFARSIT' | translate}}*:
                </div>
                <div class="ui-grid-col-9">
					<p-calendar formControlName="dataSfarsit"
							showIcon="true" 
							[dateFormat]="dateFormat"
							monthNavigator="true" 
							yearNavigator="true"
							[yearRange]="yearRange"
							showButtonBar="true"
							appendTo="body" 
							[dataType]="'date'">
					</p-calendar>
				</div>
            </div>
            <div class="ui-grid-row">
				<div class="ui-grid-col-3"></div>
				<div class="ui-grid-col-9">
					<div *ngIf="dataSfarsitFormControl.invalid && (dataSfarsitFormControl.dirty || dataSfarsitFormControl.touched)" class="ui-message ui-widget ui-corner-all ui-message-error">
						<span class="ui-message-icon pi pi-times"></span>
						<span *ngIf="dataSfarsitFormControl.errors['required']" class="ui-message-text">{{'MESSAGES.VALIDATOR_MANDATORY_FIELD' | translate}}</span>
					</div>
				</div>
            </div>  

            <div class="ui-grid-row">
                <div class="ui-grid-col-3">
					{{'LABELS.REPORT_PARTICIPARI_LA_EVENIMENTE_FILTER_RESPONSABIL_TASK' | translate}}:
                </div>
                <div class="ui-grid-col-9">
                    <p-dropdown 
                        [options]="responsabilSelectItems"
                        [placeholder]="'LABELS.SELECT' | translate"
                        [style]="{'width':'100%'}"
                        [showClear]="true"
                        appendTo="body"
                        filter="true"
                        formControlName="responsabilTask">
                    </p-dropdown>
                </div>
            </div>

            <div class="ui-grid-row">
                <div class="ui-grid-col-3">
                    {{'LABELS.REPORT_PARTICIPARI_LA_EVENIMENTE_FILTER_PROIECT' | translate}}:
                </div>
                <div class="ui-grid-col-9">
                    <p-dropdown 
                        [options]="proiecteSelectItems"
                        [placeholder]="'LABELS.SELECT' | translate"
                        [style]="{'width':'100%'}"
                        [showClear]="true"
                        appendTo="body"
                        filter="true"
                        formControlName="proiecte"
						(onChange)="onProiectSelectionChanged($event)">
                    </p-dropdown>
                </div>
            </div>

            <div class="ui-grid-row">
                <div class="ui-grid-col-3">{{"LABELS.PROJECT_SUBACTIVITY" | translate}}: </div>
                <div class="ui-grid-col-9">
                    <p-multiSelect 
                        [filter]="true"
                        [options]="subproiecteSelectItems"
                        [defaultLabel]="'LABELS.SELECT' | translate"
                        [showToggleAll]="true"
                        formControlName="subproiecte"
                        [style]="{'width':'100%'}"
                        appendTo="body">
                    </p-multiSelect>
                </div>
            </div>

            <div class="ui-grid-row">
                <div class="ui-grid-col-3">
                    {{'LABELS.REPORT_PARTICIPARI_LA_EVENIMENTE_FILTER_STATUS_TASK' | translate}}:
                </div>
                <div class="ui-grid-col-9">
                    <p-dropdown 
                        [options]="statusTaskSelectItems"
                        [placeholder]="'LABELS.SELECT' | translate"
                        [style]="{'width':'100%'}"
                        [showClear]="true"
                        appendTo="body"
                        formControlName="statusTask">
                    </p-dropdown>
                </div>
            </div>
        </div>

    </form>
    <p-footer>
        <p-button [label]="'LABELS.REPORT_VIEW' | translate" (onClick)="onView()"></p-button>
        <p-button [label]="'LABELS.EXPORT_CSV' | translate" (onClick)="onExportCSV($event)"></p-button>
    </p-footer>
</p-panel>

<p-table *ngIf="reportVisible"
    #dt
	[value]="report"
	[responsive]="true"
    [resizableColumns]="true"
    [columns]="columns"
    [loading]="loading"
    selectionMode="multiple"
    [(selection)]="selectedData" 
    [style]="{'margin-top':'5px'}"
    [scrollable]="true" 
    [scrollHeight]="scrollHeight">
    
    <ng-template pTemplate="colgroup">
        <colgroup>
            <col style="width: 50px">
            <col style="width: 20%">
            <col style="width: 20%">
            <col style="width: 10%">
            <col style="width: 10%">
            <col style="width: 15%">
            <col style="width: 15%">
            <col style="width: 10%">
        </colgroup>
    </ng-template>

    <ng-template pTemplate="header">
        <tr>
            <th>{{ 'LABELS.NO_CRT' | translate }}</th>
            <th pResizableColumn>{{ 'LABELS.REPORT_PARTICIPARI_LA_EVENIMENTE_PROIECT' | translate  }}</th>
            <th pResizableColumn>{{ 'LABELS.PROJECT_SUBACTIVITY' | translate  }}</th>
            <th pResizableColumn>{{ 'LABELS.REPORT_PARTICIPARI_LA_EVENIMENTE_NUME_TASK' | translate  }}</th>
            <th pResizableColumn>{{ 'LABELS.REPORT_PARTICIPARI_LA_EVENIMENTE_DATA_INCEPUT' | translate  }}</th>
            <th pResizableColumn>{{ 'LABELS.REPORT_PARTICIPARI_LA_EVENIMENTE_DATA_SFARSIT' | translate  }}</th>
            <th pResizableColumn>{{ 'LABELS.REPORT_PARTICIPARI_LA_EVENIMENTE_RESPONSABIL_TASK' | translate  }}</th>
            <th pResizableColumn>{{ 'LABELS.REPORT_PARTICIPARI_LA_EVENIMENTE_PARTICIPARI_LA' | translate  }}</th>
            <th pResizableColumn>{{ 'LABELS.REPORT_PARTICIPARI_LA_EVENIMENTE_STATUS_TASK' | translate  }}</th>
        </tr>
    </ng-template>
    
    <ng-template pTemplate="body" let-row let-rowIndex="rowIndex">
        <tr class="ui-widget-header" *ngIf="report[rowIndex]?.numeProiect !== report[rowIndex - 1]?.numeProiect">
            <td colspan="9">
                <span [ngStyle]="{'font-weight':'bold','font-size':'1.2em'}">{{"LABELS.REPORT_PARTICIPARI_LA_EVENIMENTE_PROIECT" | translate }}: {{row.numeProiect}}</span>
            </td>
        </tr>
        <tr class="ui-widget-header" *ngIf="report[rowIndex]?.numeSubproiect !== report[rowIndex - 1]?.numeSubproiect">
            <td colspan="9">
                <span [ngStyle]="{'font-weight':'bold'}">{{"LABELS.PROJECT_SUBACTIVITY" | translate }}: {{row.numeSubproiect}}</span>
            </td>
        </tr>
        <tr>
            <td>
                {{rowIndex + 1}}
            </td>	

            <td>
                {{ row.numeProiect }}
            </td>

            <td>
                {{ row.numeSubproiect }}
            </td>

            <td>
                {{ row.numeTask }}
            </td>

            <td>
                {{ row.dataInceputForDisplay }}
            </td>

            <td>
                {{ row.dataSfarsitForDisplay }}
            </td>

            <td>
                <div *ngIf="row.responsabiliTask.length > 1; else afiseazaResponsabil">
                    <div *ngFor="let responsabilTask of row.responsabiliTask">
                            {{ responsabilTask }};
                    </div>
                </div>
                
                <ng-template #afiseazaResponsabil>
                    {{ row.responsabiliTask }}
                </ng-template>
                
            </td>

            <td>
                {{ row.participariLa }}
            </td>

            <td>
                {{"LABELS.TASK_" + row.statusTask | translate }}
            </td>
        </tr>

    </ng-template>

    <ng-template pTemplate="emptymessage" let-columns>
        <tr>
            <td [attr.colspan]="9">
                {{ "LABELS.NO_RECORDS_FOUND" | translate }}
            </td>
        </tr>
    </ng-template>

</p-table>