<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd
        	http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

	<changeSet id="0055-stergere-documente-deja-exportate" author="CloudSoft.User1">
		<sql endDelimiter=";"><![CDATA[
			DELETE FROM export_metadata;
			DELETE FROM export_attachment;
			DELETE FROM export_document;
		]]>
		</sql>
	</changeSet>
	
	<changeSet id="0055-adaugare-coloana-name-in-tabel-export_document" author="CloudSoft.User1">
		<sql endDelimiter=";"><![CDATA[
			ALTER TABLE export_document ADD name TEXT NOT NULL;
		]]>
		</sql>
	</changeSet>
	
	<changeSet id="0055-adaugare-coloana-description-in-tabel-export_document" author="CloudSoft.User1">
		<sql endDelimiter=";"><![CDATA[
			ALTER TABLE export_document ADD description TEXT;
		]]>
		</sql>
	</changeSet>
		
	<changeSet id="0055-stergere-constrangere-export_document_uq-din-tabel-export_document" author="CloudSoft.User1">
		<sql endDelimiter=";"><![CDATA[
			ALTER TABLE export_document DROP CONSTRAINT export_document_uq;
		]]>
		</sql>
	</changeSet>
	
	<changeSet id="0055-adaugare-coloana-jr_document_location_real_name-in-tabel-export_document" author="CloudSoft.User1">
		<sql endDelimiter=";"><![CDATA[
			ALTER TABLE export_document ADD jr_document_location_real_name TEXT NOT NULL;
		]]>
		</sql>
	</changeSet>
	
	<changeSet id="0055-adaugare-constrangere-document-unic-in-tabel-export_document" author="CloudSoft.User1">
		<sql endDelimiter=";"><![CDATA[
			ALTER TABLE export_document ADD CONSTRAINT export_document_unic_document_uq UNIQUE (jr_document_location_real_name, jr_id);
		]]>
		</sql>
	</changeSet>
	
	<changeSet id="0055-adaugare-coloana-finished_date-in-workflowinstance" author="CloudSoft.User1">
		<sql endDelimiter=";"><![CDATA[
			ALTER TABLE workflowinstance ADD finished_date TIMESTAMP;
		]]>
		</sql>
	</changeSet>
	
	<changeSet id="0055-setare-valori-coloana-finished_date-in-workflowinstance" author="CloudSoft.User1">
		<sql endDelimiter=";"><![CDATA[
			UPDATE workflowinstance wi 
			SET (finished_date) = (SELECT max(task_ended_date) FROM document_history_completed_tasks dhct WHERE dhct.document_id = wi.documentid AND dhct.document_location_real_name = wi.workspacename)
			WHERE wi.status='FINNISHED';
		]]>
		</sql>
	</changeSet>
	
	<changeSet id="0055-adaugare-parametru-aplicatie-ce-reprezinta-nr-de_ani-pana-la-arhivare-document" author="CloudSoft.User1">
		<sql endDelimiter=";"><![CDATA[
			INSERT INTO parameters (id, name, description, value, type) 
			VALUES (nextval('HIBERNATE_SEQUENCE'), 'document.nr_de_ani_pana_la_arhivare', 'Reprezinta numarul de ani cat va sta documentul in aplicatie pana la arhivare.', '10', 'NUMBER');
		]]>
		</sql>
	</changeSet>
	
	<changeSet id="0055-adaugare-coloana-jr_deleted-in-export_document" author="CloudSoft.User1">
		<sql endDelimiter=";"><![CDATA[
			ALTER TABLE export_document ADD jr_deleted BOOLEAN;
		]]>
		</sql>
	</changeSet>
	
	<changeSet id="0055-adaugare-coloana-archivable-in-documenttype" author="CloudSoft.User1">
		<sql endDelimiter=";"><![CDATA[
			ALTER TABLE documenttype ADD archivable BOOLEAN DEFAULT FALSE;
		]]>
		</sql>
	</changeSet>
	
	<changeSet id="0055-marcare-tipuri-de-documente-care-se-pot-arhiva" author="CloudSoft.User1">
		<sql endDelimiter=";"><![CDATA[
			UPDATE documenttype SET archivable=true WHERE name in ('Avans Salarial', 'Conciliere', 'Initiere DSP', 'Investigatie', 'Misiune de audit si control', 'Modificare schema', 'Nota CD - Consilieri Financiari Bancari DAS', 'Nota CD - Useri ARB', 'Decizie deplasare', 'Referat suplimentare buget', 'Nota CD - Responsabil', 'Nota CD - Directori', 'Agenda sedinta PVG', 'Ordine de zi CD', 'Prezenta CD PVG', 'Proces verbal CD', 'Prezenta AGA', 'Nota PVG', 'Minuta sedinta Comisie GL', 'Cerere concediu', 'Cerere rechemare', 'Decizie rechemare', 'Prezenta Comisie GL');
		]]>
		</sql>
	</changeSet>
	
</databaseChangeLog>