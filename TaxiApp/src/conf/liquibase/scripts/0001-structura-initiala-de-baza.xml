<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd
        	http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
	
	<changeSet id="0001-creare-tabele" author="Denis">
		<sql endDelimiter=";">
		
			CREATE TABLE users (
				id BIGINT NOT NULL,
				email TEXT,
				firstname TEXT,
				lastname TEXT,
				password TEXT,
				username TEXT,
				mobile TEXT,
				
				CONSTRAINT user_pk PRIMARY KEY (id)
			);
			
			CREATE TABLE parameters (
				id BIGINT NOT NULL,
				name TEXT NOT NULL,
				description TEXT NOT NULL,
				value TEXT NOT NULL,
				type TEXT NOT NULL,
				
				CONSTRAINT parameters_pk PRIMARY KEY(id)
			);
			
			CREATE TABLE driver (
				id BIGINT NOT NULL,
				birth_date DATE NOT NULL,
				licence_number TEXT NOT NULL,
				expiry_date DATE NOT NULL,
				last_medical_exam DATE NOT NULL,
				user_id BIGINT NOT NULL,
				available BOOL,
				
				CONSTRAINT driver_pk PRIMARY KEY (id),
				CONSTRAINT driver_user_fk FOREIGN KEY (user_id) REFERENCES users (id),
				CONSTRAINT driver_user_uq UNIQUE (user_id)
			);
			
			CREATE TABLE car (
				id BIGINT NOT NULL,
				model TEXT NOT NULL,
				reg_number TEXT NOT NULL,
				last_tech_control DATE NOT NULL,
				driver_id BIGINT NOT NULL,
				
				CONSTRAINT car_pk PRIMARY KEY (id),
				CONSTRAINT car_driver_fk FOREIGN KEY (driver_id) REFERENCES driver (id)
			);
			
			CREATE TABLE client (
				id BIGINT NOT NULL,
				user_id BIGINT NOT NULL,
				
				CONSTRAINT client_pk PRIMARY KEY (id),
				CONSTRAINT client_user_fk FOREIGN KEY (user_id) REFERENCES users (id),
				CONSTRAINT client_user_uq UNIQUE (user_id)
			);
			
			CREATE TABLE card (
				id BIGINT NOT NULL,
				number TEXT NOT NULL,
				exp_date DATE NOT NULL,
				cvv INT NOT NULL,
				client_id BIGINT NOT NULL,
				
				CONSTRAINT card_pk PRIMARY KEY (id),
				CONSTRAINT card_client_fk FOREIGN KEY (client_id) REFERENCES client (id)
			);
			
			CREATE TABLE saved_place (
				id BIGINT NOT NULL,
				location TEXT NOT NULL,
				name TEXT NOT NULL,
				client_id BIGINT NOT NULL,
				
				CONSTRAINT saved_place_pk PRIMARY KEY (id),
				CONSTRAINT saved_place_client_fk FOREIGN KEY (client_id) REFERENCES client (id)
			);
			
			CREATE TABLE ride (
				id BIGINT NOT NULL,
				start_time TIMESTAMP NULL,
				end_time TIMESTAMP NULL,
				start_location TEXT NULL,
				end_location TEXT NULL,
				start_adress TEXT NULL,
				end_adress TEXT NULL,
				price NUMERIC(8,2) NULL,
				canceled BOOL NULL,
				finished BOOL NULL,
				payment_type TEXT NOT NULL,
				observations TEXT,
				client_id BIGINT NOT NULL,
				driver_id BIGINT NULL,
				dispatcher_id BIGINT NULL,
				
				CONSTRAINT ride_pk PRIMARY KEY (id),
				CONSTRAINT client_ride_fk FOREIGN KEY (client_id) REFERENCES client (id),
				CONSTRAINT driver_ride_fk FOREIGN KEY (driver_id) REFERENCES driver (id),
				CONSTRAINT dispatcher_ride_fk FOREIGN KEY (dispatcher_id) REFERENCES users(id)
			);
			
			CREATE TABLE role
			(
				id BIGINT NOT NULL,
				name TEXT NOT NULL,
				description TEXT,
				CONSTRAINT role_pk PRIMARY KEY (id),
				CONSTRAINT role_name_uq UNIQUE (name)
			);
			
			CREATE TABLE user_role
			(
				user_id BIGINT NOT NULL,
				role_id BIGINT NOT NULL,	
				CONSTRAINT user_role_pk PRIMARY KEY (user_id, role_id),
				CONSTRAINT user_role_user_id_fk FOREIGN KEY (user_id) REFERENCES USERS(id),
				CONSTRAINT user_role_role_id_fk FOREIGN KEY (role_id) REFERENCES ROLE(id)
			);
			
			CREATE TABLE permission_group (
				id BIGINT NOT NULL,
				name TEXT NOT NULL,
				label TEXT NOT NULL,
				description TEXT,
				
				CONSTRAINT permission_group_pk PRIMARY KEY (id)
			);
			
			CREATE TABLE permission (
				id BIGINT NOT NULL,
				name TEXT NOT NULL,
				label TEXT NOT NULL,
				description TEXT,
				permission_group_id BIGINT NOT NULL,
				
				CONSTRAINT permission_pk PRIMARY KEY (id),
				CONSTRAINT permission_permission_group_id_fk FOREIGN KEY (permission_group_id) REFERENCES permission_group (id)
			);
			
			CREATE TABLE role_permission (
				role_id BIGINT NOT NULL,
				permission_id BIGINT NOT NULL,
				
				CONSTRAINT role_permission_pk PRIMARY KEY (role_id, permission_id),
				CONSTRAINT role_permission_role_id_fk FOREIGN KEY (role_id) REFERENCES role (id),
				CONSTRAINT role_permission_permission_id_fk FOREIGN KEY (permission_id) REFERENCES permission (id)
			);
			
		</sql>
	</changeSet>
	
	<changeSet id="0001-creare-secvente" author="Denis">
		<sql endDelimiter=";">
			CREATE SEQUENCE HIBERNATE_SEQUENCE START 1;
		</sql>
	</changeSet>
	
</databaseChangeLog>